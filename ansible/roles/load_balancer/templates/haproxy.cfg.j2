defaults
  mode http
  timeout client       60s
  timeout connect      5s
  timeout server       10s
  timeout http-request 10s

frontend http
  bind :80

  # acls
  acl host_consul hdr(host)  -i consul.localhost
  acl host_vault hdr(host)   -i vault.localhost
  acl host_nomad hdr(host)   -i nomad.localhost
  acl host_traefik hdr(host) -i traefik.localhost

  # backends
  use_backend consul_dashboard  if host_consul
  use_backend vault_dashboard   if host_vault
  use_backend nomad_dashboard   if host_nomad
  use_backend traefik_dashboard if host_traefik

  default_backend infra_clients

backend consul_dashboard
  {% for backend in groups["consul_servers"] -%}
  server {{ backend }} {{ hostvars[backend].ansible_host }}:8500
  {% endfor %}

backend vault_dashboard
  {% for backend in groups["vault_servers"] -%}
  server {{ backend }} {{ hostvars[backend].ansible_host }}:8200
  {% endfor %}

backend nomad_dashboard
  {% for backend in groups["nomad_servers"] -%}
  server {{ backend }} {{ hostvars[backend].ansible_host }}:4646
  {% endfor %}

backend traefik_dashboard
  {% for backend in groups["nomad_infra_clients"] -%}
  server {{ backend }} {{ hostvars[backend].ansible_host }}:8080
  {% endfor %}

backend infra_clients
  {% for backend in groups["nomad_infra_clients"] -%}
  server {{ backend }} {{ hostvars[backend].ansible_host }}:80
  {% endfor %}
